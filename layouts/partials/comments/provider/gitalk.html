{{- with .Site.Params.comments.gitalk -}}
<!-- Gitalkè¯„è®ºç³»ç»Ÿ -->
<div id="gitalk-container" class="gitalk-container"></div>

<!-- Gitalk CSS -->
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.css"
/>

<!-- è‡ªå®šä¹‰Gitalkæ ·å¼ -->
<style>
.gitalk-container {
    margin-top: 2rem;
    padding: 1.5rem;
    background: var(--card-background);
    border-radius: var(--card-border-radius);
    box-shadow: var(--shadow-l1);
    border: 1px solid var(--card-separator-color);
}

.gt-container .gt-header-textarea {
    background: var(--card-background);
    color: var(--card-text-color-main);
    border: 1px solid var(--card-separator-color);
    border-radius: var(--card-border-radius);
}

.gt-container .gt-header-textarea:focus {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px var(--accent-color-lighter);
}

.gt-container .gt-btn-public {
    background: var(--accent-color);
    border-color: var(--accent-color);
    color: white;
}

.gt-container .gt-btn-public:hover {
    background: var(--accent-color-darker);
    border-color: var(--accent-color-darker);
}

.gt-container .gt-comment-content {
    background: var(--card-background);
    color: var(--card-text-color-main);
}

.gt-container .gt-comment-body {
    color: var(--card-text-color-main) !important;
}

.gt-container .gt-comment-admin .gt-comment-content {
    background: var(--accent-color-lighter);
}

/* æ·±è‰²æ¨¡å¼é€‚é… */
[data-scheme="dark"] .gt-container .gt-svg svg {
    fill: var(--card-text-color-secondary);
}

[data-scheme="dark"] .gt-container .gt-meta {
    color: var(--card-text-color-secondary);
}

/* ç§»åŠ¨ç«¯ä¼˜åŒ– */
@media (max-width: 768px) {
    .gitalk-container {
        margin-top: 1rem;
        padding: 1rem;
    }

    .gt-container .gt-header-textarea {
        font-size: 14px;
    }
}
</style>

<!-- Gitalk JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.19.0/js/md5.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // æ£€æŸ¥æ˜¯å¦åœ¨æœ¬åœ°ç¯å¢ƒ
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) !== -1) {
        document.getElementById("gitalk-container").innerHTML =
            '<div style="text-align: center; padding: 2rem; color: var(--card-text-color-secondary);">' +
            '<p>ğŸ“ Gitalkè¯„è®ºç³»ç»Ÿ</p>' +
            '<p>è¯„è®ºåŠŸèƒ½åœ¨æœ¬åœ°é¢„è§ˆæ—¶ä¸å¯ç”¨ï¼Œè¯·åœ¨çº¿ä¸Šç¯å¢ƒæŸ¥çœ‹ã€‚</p>' +
            '</div>';
        return;
    }

    // æ£€æŸ¥æ˜¯å¦å¯ç”¨Gitalkå’Œå¿…è¦çš„é…ç½®
    {{- if and (ne .enabled false) .clientID .clientSecret .owner .repo -}}
    {{- if and (ne .clientID "PLACEHOLDER_CLIENT_ID") (ne .clientSecret "PLACEHOLDER_CLIENT_SECRET") -}}

    // ç¡®ä¿åœ¨DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
    function initializeGitalk() {
        // æ£€æŸ¥ä¾èµ–æ˜¯å¦åŠ è½½
        if (typeof Gitalk === 'undefined' || typeof md5 === 'undefined') {
            console.log('Gitalk dependencies not loaded yet, retrying...');
            setTimeout(initializeGitalk, 500);
            return;
        }

        // æ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨
        var container = document.getElementById('gitalk-container');
        if (!container) {
            console.log('Gitalk container not found, retrying...');
            setTimeout(initializeGitalk, 500);
            return;
        }

        // ç”Ÿæˆå”¯ä¸€IDï¼ˆé™åˆ¶åœ¨50å­—ç¬¦ä»¥å†…ï¼‰
        var pageId = md5(location.pathname).substring(0, 50);

        var gitalk = new Gitalk({
            clientID: "{{- .clientID -}}",
            clientSecret: "{{- .clientSecret -}}",
            repo: "{{- .repo -}}",
            owner: "{{- .owner -}}",
            admin: ["{{- .admin -}}"],
            id: pageId,
            distractionFreeMode: false,
            pagerDirection: 'last',
            createIssueManually: true,  // æ”¹ä¸ºæ‰‹åŠ¨åˆ›å»ºï¼Œé¿å…æƒé™é—®é¢˜
            {{- if .proxy -}}
            proxy: "{{- .proxy -}}",
            {{- end -}}
            // æœ¬åœ°åŒ–è®¾ç½®
            language: 'zh-CN',
            perPage: 10,
            // å¯ç”¨è¡¨æƒ…ç¬¦å·
            enableHotKey: true,
            // æ ‡ç­¾è®¾ç½®
            labels: ['gitalk', 'comment'],
            // ä¸»é¢˜é€‚é…
            theme: document.documentElement.getAttribute('data-scheme') || 'light'
        });

        // æ¸²æŸ“è¯„è®º
        gitalk.render('gitalk-container');
        console.log('âœ… Gitalk initialized successfully');

        // æ·»åŠ é”™è¯¯å¤„ç†
        gitalk.on('error', function(error) {
            console.error('Gitalk error:', error);
            var container = document.getElementById('gitalk-container');
            if (container && error.message) {
                if (error.message.includes('403')) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--card-text-color-secondary);">
                            <h4>ğŸ” è¯„è®ºç³»ç»Ÿé…ç½®æç¤º</h4>
                            <p>è¯„è®ºåŠŸèƒ½éœ€è¦ç®¡ç†å‘˜é…ç½®GitHub OAuthæƒé™ã€‚</p>
                            <p>å¦‚æœæ‚¨æ˜¯ç®¡ç†å‘˜ï¼Œè¯·æ£€æŸ¥ï¼š</p>
                            <ul style="text-align: left; max-width: 400px; margin: 1rem auto;">
                                <li>GitHub OAuthåº”ç”¨çš„å›è°ƒURLè®¾ç½®</li>
                                <li>my_blog_sourceä»“åº“çš„è®¿é—®æƒé™</li>
                                <li>OAuthåº”ç”¨çš„æƒé™èŒƒå›´</li>
                            </ul>
                            <p><small>é”™è¯¯ä»£ç : 403 Forbidden</small></p>
                        </div>
                    `;
                } else if (error.message.includes('404')) {
                    // 404é”™è¯¯æ˜¯æ­£å¸¸çš„ï¼Œè¡¨ç¤ºè¿˜æ²¡æœ‰å¯¹åº”çš„Issue
                    console.log('â„¹ï¸ No existing issue found, this is normal for new posts');
                }
            }
        });

        // ç›‘å¬ä¸»é¢˜å˜åŒ–
        if (window.MutationObserver) {
            var observer = new MutationObserver(function(mutations) {
                for (var i = 0; i < mutations.length; i++) {
                    var mutation = mutations[i];
                    if (mutation.type === 'attributes' && mutation.attributeName === 'data-scheme') {
                        // ä¸»é¢˜å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“ï¼ˆå¯é€‰ï¼‰
                        console.log('Theme changed, Gitalk will adapt automatically');
                    }
                }
            });

            observer.observe(document.documentElement, {
                attributes: true,
                attributeFilter: ['data-scheme']
            });
        }
    }

    // è‡ªåŠ¨åˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeGitalk);
    } else {
        initializeGitalk();
    }
    {{- else -}}
    // æ˜¾ç¤ºè¯¦ç»†çš„é…ç½®æŒ‡å—
    document.getElementById("gitalk-container").innerHTML = `
        <div style="text-align: center; padding: 2rem; color: var(--card-text-color-secondary); border: 1px solid var(--card-separator-color); border-radius: 8px; background: var(--card-background);">
            <h4>ğŸ”§ è¯„è®ºç³»ç»Ÿé…ç½®æŒ‡å—</h4>
            <p>è¯„è®ºåŠŸèƒ½éœ€è¦é…ç½®GitHub OAuthåº”ç”¨ã€‚</p>
            <details style="margin-top: 1rem; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                <summary style="cursor: pointer; font-weight: 500; color: var(--accent-color);">ğŸ“‹ ç‚¹å‡»æŸ¥çœ‹é…ç½®æ­¥éª¤</summary>
                <div style="margin-top: 1rem; padding: 1rem; background: var(--accent-color-lighter); border-radius: 6px; font-size: 0.9rem;">
                    <p><strong>æ­¥éª¤1: åˆ›å»ºOAuthåº”ç”¨</strong></p>
                    <p>è®¿é—®: <a href="https://github.com/settings/applications/new" target="_blank" style="color: var(--accent-color);">GitHub OAuth Apps</a></p>

                    <p><strong>æ­¥éª¤2: å¡«å†™åº”ç”¨ä¿¡æ¯</strong></p>
                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                        <li>Application name: <code>Lanniny Blog Comments</code></li>
                        <li>Homepage URL: <code>https://lanniny-blog.netlify.app</code></li>
                        <li>Authorization callback URL: <code>https://lanniny-blog.netlify.app/</code></li>
                    </ul>

                    <p><strong>æ­¥éª¤3: æ›´æ–°é…ç½®</strong></p>
                    <p>å°†è·å¾—çš„Client IDå’ŒClient Secretæ›´æ–°åˆ°åšå®¢é…ç½®æ–‡ä»¶ä¸­ï¼Œå¹¶è®¾ç½® <code>enabled: true</code></p>

                    <p style="margin-top: 1rem; padding: 0.5rem; background: var(--card-background); border-radius: 4px; border-left: 3px solid var(--accent-color);">
                        <strong>ğŸ’¡ æç¤º:</strong> ç¡®ä¿my_blog_sourceä»“åº“æ˜¯å…¬å¼€çš„ï¼Œå¹¶å¯ç”¨äº†IssuesåŠŸèƒ½ã€‚
                    </p>
                </div>
            </details>
        </div>
    `;
    console.log('â„¹ï¸ å·²æ˜¾ç¤ºGitalké…ç½®æŒ‡å—');
    {{- end -}}
});
</script>
{{ end }}
