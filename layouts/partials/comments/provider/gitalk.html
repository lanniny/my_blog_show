{{- with .Site.Params.comments.gitalk -}}
<!-- Gitalkè¯„è®ºç³»ç»Ÿ -->
<div id="gitalk-container" class="gitalk-container"></div>

<!-- Gitalk CSS -->
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.css"
/>

<!-- è‡ªå®šä¹‰Gitalkæ ·å¼ -->
<style>
.gitalk-container {
    margin-top: 2rem;
    padding: 1.5rem;
    background: var(--card-background);
    border-radius: var(--card-border-radius);
    box-shadow: var(--shadow-l1);
    border: 1px solid var(--card-separator-color);
}

.gt-container .gt-header-textarea {
    background: var(--card-background);
    color: var(--card-text-color-main);
    border: 1px solid var(--card-separator-color);
    border-radius: var(--card-border-radius);
}

.gt-container .gt-header-textarea:focus {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px var(--accent-color-lighter);
}

.gt-container .gt-btn-public {
    background: var(--accent-color);
    border-color: var(--accent-color);
    color: white;
}

.gt-container .gt-btn-public:hover {
    background: var(--accent-color-darker);
    border-color: var(--accent-color-darker);
}

.gt-container .gt-comment-content {
    background: var(--card-background);
    color: var(--card-text-color-main);
}

.gt-container .gt-comment-body {
    color: var(--card-text-color-main) !important;
}

.gt-container .gt-comment-admin .gt-comment-content {
    background: var(--accent-color-lighter);
}

/* æ·±è‰²æ¨¡å¼é€‚é… */
[data-scheme="dark"] .gt-container .gt-svg svg {
    fill: var(--card-text-color-secondary);
}

[data-scheme="dark"] .gt-container .gt-meta {
    color: var(--card-text-color-secondary);
}

/* ç§»åŠ¨ç«¯ä¼˜åŒ– */
@media (max-width: 768px) {
    .gitalk-container {
        margin-top: 1rem;
        padding: 1rem;
    }

    .gt-container .gt-header-textarea {
        font-size: 14px;
    }
}
</style>

<!-- Gitalk JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.19.0/js/md5.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // æ£€æŸ¥æ˜¯å¦åœ¨æœ¬åœ°ç¯å¢ƒ
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) !== -1) {
        document.getElementById("gitalk-container").innerHTML =
            '<div style="text-align: center; padding: 2rem; color: var(--card-text-color-secondary);">' +
            '<p>ğŸ“ Gitalkè¯„è®ºç³»ç»Ÿ</p>' +
            '<p>è¯„è®ºåŠŸèƒ½åœ¨æœ¬åœ°é¢„è§ˆæ—¶ä¸å¯ç”¨ï¼Œè¯·åœ¨çº¿ä¸Šç¯å¢ƒæŸ¥çœ‹ã€‚</p>' +
            '</div>';
        return;
    }

    // æ£€æŸ¥å¿…è¦çš„é…ç½®
    {{- if and .clientID .clientSecret .owner .repo -}}
    try {
        // ç”Ÿæˆå”¯ä¸€IDï¼ˆé™åˆ¶åœ¨50å­—ç¬¦ä»¥å†…ï¼‰
        const pageId = md5(location.pathname).substring(0, 50);

        const gitalk = new Gitalk({
            clientID: "{{- .clientID -}}",
            clientSecret: "{{- .clientSecret -}}",
            repo: "{{- .repo -}}",
            owner: "{{- .owner -}}",
            admin: ["{{- .admin -}}"],
            id: pageId,
            distractionFreeMode: false,
            pagerDirection: 'last',
            createIssueManually: false,
            {{- if .proxy -}}
            proxy: "{{- .proxy -}}",
            {{- end -}}
            // æœ¬åœ°åŒ–è®¾ç½®
            language: 'zh-CN',
            perPage: 10,
            // å¯ç”¨è¡¨æƒ…ç¬¦å·
            enableHotKey: true,
            // æ ‡ç­¾è®¾ç½®
            labels: ['gitalk', 'comment'],
            // ä¸»é¢˜é€‚é…
            theme: document.documentElement.getAttribute('data-scheme') || 'light'
        });

        // æ¸²æŸ“è¯„è®º
        gitalk.render('gitalk-container');

        // ç›‘å¬ä¸»é¢˜å˜åŒ–
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'data-scheme') {
                    // ä¸»é¢˜å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“ï¼ˆå¯é€‰ï¼‰
                    console.log('Theme changed, Gitalk will adapt automatically');
                }
            });
        });

        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['data-scheme']
        });

    } catch (error) {
        console.error('Gitalk initialization error:', error);
        document.getElementById("gitalk-container").innerHTML =
            '<div style="text-align: center; padding: 2rem; color: var(--card-text-color-secondary);">' +
            '<p>âŒ è¯„è®ºç³»ç»ŸåŠ è½½å¤±è´¥</p>' +
            '<p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚</p>' +
            '</div>';
    }
    {{- else -}}
    // é…ç½®ä¸å®Œæ•´çš„æç¤º
    document.getElementById("gitalk-container").innerHTML =
        '<div style="text-align: center; padding: 2rem; color: var(--card-text-color-secondary);">' +
        '<p>âš™ï¸ è¯„è®ºç³»ç»Ÿé…ç½®ä¸­</p>' +
        '<p>ç®¡ç†å‘˜æ­£åœ¨é…ç½®GitHub OAuthåº”ç”¨ï¼Œè¯„è®ºåŠŸèƒ½å³å°†å¼€æ”¾ã€‚</p>' +
        '</div>';
    {{- end -}}
});
</script>
{{ end }}
