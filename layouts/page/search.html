{{ define "body-class" }}template-search{{ end }}
{{ define "head" }}
    {{- with .OutputFormats.Get "json" -}} 
        <link rel="preload" href="{{ .RelPermalink }}" as="fetch" crossorigin="anonymous">
    {{- end -}}
{{ end }}
{{ define "main" }}
<form action="{{ .RelPermalink }}" class="search-form"{{ with .OutputFormats.Get "json" -}} data-json="{{ .RelPermalink }}"{{- end }}>
    <!-- 主搜索区域 -->
    <div class="search-main-container">
        <div class="search-input-wrapper">
            <label class="search-label">{{ T "search.title" }}</label>
            <div class="search-input-group">
                <input name="keyword" class="search-input" placeholder="{{ T `search.placeholder` }}" />
                <button type="submit" class="search-button" title="{{ T `search.title` }}">
                    {{ partial "helper/icon" "search" }}
                </button>
                <button type="button" class="advanced-toggle-btn" title="高级搜索选项">
                    <svg class="filter-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- 简化的高级搜索面板 -->
    <div class="search-filters" id="search-filters">
        <div class="filters-container">
            <div class="filter-row">
                <label>分类：</label>
                <select name="category">
                    <option value="">全部</option>
                    {{ range .Site.Taxonomies.categories }}
                        <option value="{{ .Page.Title }}">{{ .Page.Title }}</option>
                    {{ end }}
                </select>
            </div>

            <div class="filter-row">
                <label>排序：</label>
                <select name="sort">
                    <option value="relevance">相关性</option>
                    <option value="date-desc">最新</option>
                    <option value="date-asc">最早</option>
                </select>
            </div>

            <div class="filter-row">
                <label>标签：</label>
                <select name="tags" multiple>
                    {{ range .Site.Taxonomies.tags }}
                        <option value="{{ .Page.Title }}">{{ .Page.Title }}</option>
                    {{ end }}
                </select>
            </div>

            <div class="filter-actions">
                <button type="button" class="btn-reset">重置</button>
                <button type="submit" class="btn-search">搜索</button>
            </div>
        </div>
    </div>
</form>

<div class="search-result">
    <h3 class="search-result--title section-title"></h3>
    <div class="search-result--list article-list--compact"></div>
</div>

<script>
    window.searchResultTitleTemplate = "{{ T `search.resultTitle` }}"
</script>

{{- $opts := dict "minify" hugo.IsProduction "JSXFactory" "createElement" -}}
{{- $searchScript := resources.Get "ts/search.tsx" | js.Build $opts -}}
{{- $advancedSearchScript := resources.Get "ts/advanced-search.ts" | js.Build $opts -}}
<script type="text/javascript" src="{{ $searchScript.RelPermalink }}" defer></script>
<script type="text/javascript" src="{{ $advancedSearchScript.RelPermalink }}" defer></script>

<script>
// 初始化高级搜索功能
window.addEventListener('load', () => {
    setTimeout(() => {
        // 等待原始搜索初始化完成
        const searchForm = document.querySelector('.search-form');
        if (searchForm && window.AdvancedSearch) {
            // 获取原始搜索实例（假设它被存储在全局变量中）
            const originalSearchInstance = window.searchInstance || {
                getData: async () => {
                    const jsonURL = searchForm.dataset.json;
                    const response = await fetch(jsonURL);
                    const data = await response.json();
                    const parser = new DOMParser();

                    for (const item of data) {
                        item.content = parser.parseFromString(item.content, 'text/html').body.innerText;
                    }

                    return data;
                }
            };

            // 初始化高级搜索
            new window.AdvancedSearch(originalSearchInstance);
            console.log('✅ 高级搜索功能已启用');
        }
    }, 100);
});
</script>

{{ partialCached "footer/footer" . }}
{{ end }}