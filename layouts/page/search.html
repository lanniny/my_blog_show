{{ define "body-class" }}template-search{{ end }}
{{ define "head" }}
    {{- with .OutputFormats.Get "json" -}} 
        <link rel="preload" href="{{ .RelPermalink }}" as="fetch" crossorigin="anonymous">
    {{- end -}}
{{ end }}
{{ define "main" }}
<form action="{{ .RelPermalink }}" class="search-form"{{ with .OutputFormats.Get "json" -}} data-json="{{ .RelPermalink }}"{{- end }}>
    <!-- ä¸»æœç´¢åŒºåŸŸ -->
    <div class="search-main-container">
        <div class="search-input-wrapper">
            <label class="search-label">{{ T "search.title" }}</label>
            <div class="search-input-group">
                <input name="keyword" class="search-input" placeholder="{{ T `search.placeholder` }}" />
                <button type="submit" class="search-button" title="{{ T `search.title` }}">
                    {{ partial "helper/icon" "search" }}
                </button>
                <button type="button" class="advanced-toggle-btn" title="é«˜çº§æœç´¢é€‰é¡¹">
                    <svg class="filter-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- é«˜çº§æœç´¢é¢æ¿ -->
    <div class="advanced-filters-panel" id="advanced-filters-panel">
        <div class="filters-header">
            <h4 class="filters-title">ğŸ” é«˜çº§æœç´¢é€‰é¡¹</h4>
            <button type="button" class="filters-close" title="å…³é—­é«˜çº§æœç´¢">Ã—</button>
        </div>

        <div class="filters-content">
            <!-- ç¬¬ä¸€è¡Œï¼šåˆ†ç±»å’Œæ’åº -->
            <div class="filters-row">
                <div class="filter-item">
                    <label class="filter-label">ğŸ“ åˆ†ç±»ç­›é€‰</label>
                    <select name="category" class="filter-select">
                        <option value="">æ‰€æœ‰åˆ†ç±»</option>
                        {{ range .Site.Taxonomies.categories }}
                            <option value="{{ .Page.Title }}">{{ .Page.Title }} ({{ len .Pages }})</option>
                        {{ end }}
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label">ğŸ“Š æ’åºæ–¹å¼</label>
                    <select name="sort" class="filter-select">
                        <option value="relevance">ç›¸å…³æ€§</option>
                        <option value="date-desc">æœ€æ–°å‘å¸ƒ</option>
                        <option value="date-asc">æœ€æ—©å‘å¸ƒ</option>
                        <option value="title">æ ‡é¢˜æ’åº</option>
                    </select>
                </div>
            </div>

            <!-- ç¬¬äºŒè¡Œï¼šæ ‡ç­¾ç­›é€‰ -->
            <div class="filters-row filters-row-wide">
                <div class="filter-item filter-item-wide">
                    <label class="filter-label">ğŸ·ï¸ æ ‡ç­¾ç­›é€‰</label>
                    <div class="tag-filter-wrapper">
                        <input type="text" class="tag-filter-input" placeholder="æœç´¢æ ‡ç­¾..." />
                        <div class="tag-filter-dropdown">
                            {{ range .Site.Taxonomies.tags }}
                                <label class="tag-option">
                                    <input type="checkbox" name="tags" value="{{ .Page.Title }}" />
                                    <span class="tag-text">{{ .Page.Title }}</span>
                                    <span class="tag-count">({{ len .Pages }})</span>
                                </label>
                            {{ end }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç¬¬ä¸‰è¡Œï¼šæ—¶é—´èŒƒå›´ -->
            <div class="filters-row filters-row-wide">
                <div class="filter-item filter-item-wide">
                    <label class="filter-label">ğŸ“… æ—¶é—´èŒƒå›´</label>
                    <div class="date-range-wrapper">
                        <input type="date" name="date-from" class="date-input" placeholder="å¼€å§‹æ—¥æœŸ" />
                        <span class="date-separator">è‡³</span>
                        <input type="date" name="date-to" class="date-input" placeholder="ç»“æŸæ—¥æœŸ" />
                    </div>
                </div>
            </div>
        </div>

        <div class="filters-actions">
            <button type="button" class="btn-clear">æ¸…é™¤ç­›é€‰</button>
            <button type="submit" class="btn-apply">åº”ç”¨ç­›é€‰</button>
        </div>
    </div>
</form>

<div class="search-result">
    <h3 class="search-result--title section-title"></h3>
    <div class="search-result--list article-list--compact"></div>
</div>

<script>
    window.searchResultTitleTemplate = "{{ T `search.resultTitle` }}"
</script>

{{- $opts := dict "minify" hugo.IsProduction "JSXFactory" "createElement" -}}
{{- $searchScript := resources.Get "ts/search.tsx" | js.Build $opts -}}
{{- $advancedSearchScript := resources.Get "ts/advanced-search.ts" | js.Build $opts -}}
<script type="text/javascript" src="{{ $searchScript.RelPermalink }}" defer></script>
<script type="text/javascript" src="{{ $advancedSearchScript.RelPermalink }}" defer></script>

<script>
// åˆå§‹åŒ–é«˜çº§æœç´¢åŠŸèƒ½
window.addEventListener('load', () => {
    setTimeout(() => {
        // ç­‰å¾…åŸå§‹æœç´¢åˆå§‹åŒ–å®Œæˆ
        const searchForm = document.querySelector('.search-form');
        if (searchForm && window.AdvancedSearch) {
            // è·å–åŸå§‹æœç´¢å®ä¾‹ï¼ˆå‡è®¾å®ƒè¢«å­˜å‚¨åœ¨å…¨å±€å˜é‡ä¸­ï¼‰
            const originalSearchInstance = window.searchInstance || {
                getData: async () => {
                    const jsonURL = searchForm.dataset.json;
                    const response = await fetch(jsonURL);
                    const data = await response.json();
                    const parser = new DOMParser();

                    for (const item of data) {
                        item.content = parser.parseFromString(item.content, 'text/html').body.innerText;
                    }

                    return data;
                }
            };

            // åˆå§‹åŒ–é«˜çº§æœç´¢
            new window.AdvancedSearch(originalSearchInstance);
            console.log('âœ… é«˜çº§æœç´¢åŠŸèƒ½å·²å¯ç”¨');
        }
    }, 100);
});
</script>

{{ partialCached "footer/footer" . }}
{{ end }}