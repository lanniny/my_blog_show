{{ define "body-class" }}template-search{{ end }}
{{ define "head" }}
    {{- with .OutputFormats.Get "json" -}} 
        <link rel="preload" href="{{ .RelPermalink }}" as="fetch" crossorigin="anonymous">
    {{- end -}}
{{ end }}
{{ define "main" }}
<form action="{{ .RelPermalink }}" class="search-form"{{ with .OutputFormats.Get "json" -}} data-json="{{ .RelPermalink }}"{{- end }}>
    <!-- 主搜索区域 -->
    <div class="search-main-container">
        <div class="search-input-wrapper">
            <label class="search-label">{{ T "search.title" }}</label>
            <div class="search-input-group">
                <input name="keyword" class="search-input" placeholder="{{ T `search.placeholder` }}" />
                <button type="submit" class="search-button" title="{{ T `search.title` }}">
                    {{ partial "helper/icon" "search" }}
                </button>
                <button type="button" class="advanced-toggle-btn" title="高级搜索选项">
                    <svg class="filter-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- 高级搜索面板 -->
    <div class="advanced-filters-panel" id="advanced-filters-panel">
        <div class="filters-header">
            <h4 class="filters-title">🔍 高级搜索选项</h4>
            <button type="button" class="filters-close" title="关闭高级搜索">×</button>
        </div>

        <div class="filters-content">
            <!-- 第一行：分类和排序 -->
            <div class="filters-row">
                <div class="filter-item">
                    <label class="filter-label">📁 分类筛选</label>
                    <select name="category" class="filter-select">
                        <option value="">所有分类</option>
                        {{ range .Site.Taxonomies.categories }}
                            <option value="{{ .Page.Title }}">{{ .Page.Title }} ({{ len .Pages }})</option>
                        {{ end }}
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label">📊 排序方式</label>
                    <select name="sort" class="filter-select">
                        <option value="relevance">相关性</option>
                        <option value="date-desc">最新发布</option>
                        <option value="date-asc">最早发布</option>
                        <option value="title">标题排序</option>
                    </select>
                </div>
            </div>

            <!-- 第二行：标签筛选 -->
            <div class="filters-row filters-row-wide">
                <div class="filter-item filter-item-wide">
                    <label class="filter-label">🏷️ 标签筛选</label>
                    <div class="tag-filter-wrapper">
                        <input type="text" class="tag-filter-input" placeholder="搜索标签..." />
                        <div class="tag-filter-dropdown">
                            {{ range .Site.Taxonomies.tags }}
                                <label class="tag-option">
                                    <input type="checkbox" name="tags" value="{{ .Page.Title }}" />
                                    <span class="tag-text">{{ .Page.Title }}</span>
                                    <span class="tag-count">({{ len .Pages }})</span>
                                </label>
                            {{ end }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 第三行：时间范围 -->
            <div class="filters-row filters-row-wide">
                <div class="filter-item filter-item-wide">
                    <label class="filter-label">📅 时间范围</label>
                    <div class="date-range-wrapper">
                        <input type="date" name="date-from" class="date-input" placeholder="开始日期" />
                        <span class="date-separator">至</span>
                        <input type="date" name="date-to" class="date-input" placeholder="结束日期" />
                    </div>
                </div>
            </div>
        </div>

        <div class="filters-actions">
            <button type="button" class="btn-clear">清除筛选</button>
            <button type="submit" class="btn-apply">应用筛选</button>
        </div>
    </div>
</form>

<div class="search-result">
    <h3 class="search-result--title section-title"></h3>
    <div class="search-result--list article-list--compact"></div>
</div>

<script>
    window.searchResultTitleTemplate = "{{ T `search.resultTitle` }}"
</script>

{{- $opts := dict "minify" hugo.IsProduction "JSXFactory" "createElement" -}}
{{- $searchScript := resources.Get "ts/search.tsx" | js.Build $opts -}}
{{- $advancedSearchScript := resources.Get "ts/advanced-search.ts" | js.Build $opts -}}
<script type="text/javascript" src="{{ $searchScript.RelPermalink }}" defer></script>
<script type="text/javascript" src="{{ $advancedSearchScript.RelPermalink }}" defer></script>

<script>
// 初始化高级搜索功能
window.addEventListener('load', () => {
    setTimeout(() => {
        // 等待原始搜索初始化完成
        const searchForm = document.querySelector('.search-form');
        if (searchForm && window.AdvancedSearch) {
            // 获取原始搜索实例（假设它被存储在全局变量中）
            const originalSearchInstance = window.searchInstance || {
                getData: async () => {
                    const jsonURL = searchForm.dataset.json;
                    const response = await fetch(jsonURL);
                    const data = await response.json();
                    const parser = new DOMParser();

                    for (const item of data) {
                        item.content = parser.parseFromString(item.content, 'text/html').body.innerText;
                    }

                    return data;
                }
            };

            // 初始化高级搜索
            new window.AdvancedSearch(originalSearchInstance);
            console.log('✅ 高级搜索功能已启用');
        }
    }, 100);
});
</script>

{{ partialCached "footer/footer" . }}
{{ end }}